{"mappings":";;;AAOA,MAAM,YAAE,8BAAQ,EAAE,GAAG;AACrB,SAAS,6BAA6B,GAAM,EAAE,GAAM,EAAE,GAAS;IAC7D,IAAI,CAAC,+BAAS,MAAM,GAAG,CAAC,IAAI,GAAG;IAC/B,OAAO;AACT;AACA,MAAM,oCAAiC;AAuBhC,SAAS,0CAAO,UACrB,SAAS,CAAA,GAAA,aAAM,GACf,YAAA,cAAa,iCAAW,YACxB,WAAW,CAAA,GAAA,eAAQ,uBACnB,qBAAqB,CAAA,GAAA,yBAAkB,aACvC,WAAW,CAAA,GAAA,eAAQ,GACR,GAAG,CAAC,CAAC;IAChB,OAAO,MAAM;QACX,OAAO,CAAA,OAAQ,GAAqB,UAAU;QAC9C,WAAW,UAAU;YACnB,OAAO,IAAI,CAAC,CAAA,OAAQ;QACtB;QACA,OAAO,CAAA,UAAW,CAAC,UAA4B;YAC7C,IAAI,CAAC,CAAA,OAAQ,GAAG;YAChB,MACE,cACA,mBAAmB,GAAG,CAAC,IAAI,CAAC,CAAA,gBAAiB,EAAE,YAC/C;gBACA,MAAM,IAAI,mBAAmB,GAAG,CAAC,IAAI,CAAC,CAAA,gBAAiB,EAAE;gBACzD,mBAAmB,MAAM,CAAC,IAAI,CAAC,CAAA,gBAAiB,EAAE;gBAClD;YACF;YACA,MAAO,eAAe,aAAa,IAAI,CAAC,CAAA,yBAA0B,CAAE;gBAClE,MAAM,MAAM,IAAI,CAAC,CAAA,yBAA0B;gBAC3C,IAAI,CAAC,CAAA,yBAA0B,GAAG;gBAClC;YACF;QACF;QACA,OAAO,CAAA,YAAa,GAAmB,YAAW,OAAO,CAAC;QAC1D,OAAO,CAAA,gBAAiB,GAA8B,IAAI,WAAW;QACrE,OAAO,CAAA,QAAS,GAAsB,IAAI,WAAW;QACrD,CAAA,gBAAiB,GAAsB,IAAI,WAAW;QACtD,OAAO,CAAA,WAAY,CAAC,IAAsB;YACxC,IAAI,SAAS,WACX,OAAO,KAAK,CAAA,QAAS;YAEvB,OAAO,KAAK,CAAA,gBAAiB;QAC/B;QACA,WAAW,CAAA,eAAgB;YACzB,OAAO,KAAK,CAAA,WAAY,CAAC,KAAK,CAAA,OAAQ;QACxC;QACA,OAAO,CAAA,yBAA0B,GAA6B,UAAU;QACxE,OAAO,CAAA,aAAc,GAAmB,6BACtC,aACA,WACA,IAAI,OAAO,IAAI,CAAC,CAAA,YAAa,EAAE;YAC7B,OAAM,MAAM,EAAE,OAAO,EAAE,QAAQ;gBAC7B,IAAI,SAAS,MAAM,EAAE,QAAQ,CAAC,EAAE,GAAG,KAAK,CAAA,IAAK,CAAC,QAAQ,CAAC,EAAE;gBACzD,OAAO,SAAS,KAAK,CAAC,QAAQ,SAAS;YACzC;YACA,WAAU,MAAM,EAAE,QAAQ,EAAE,OAAO;gBACjC,IAAI,SAAS,MAAM,EAAE,QAAQ,CAAC,EAAE,GAAG,KAAK,CAAA,IAAK,CAAC,QAAQ,CAAC,EAAE;gBACzD,OAAO,SAAS,SAAS,CAAC,QAAQ,UAAU;YAC9C;QACF,IACA;QACF,iGAAiG;QACjG,6CAA6C;QAC7C,oDAAoD;QACpD,2CAA2C;QAC3C,qCAAqC;QACrC,oEAAoE;QACpE,oBAAoB;QACpB,iBAAiB;QACjB,aAAa;QACb,gEAAgE;QAChE,QAAQ;QACR,OAAO;QACP,4BAA4B;QAC5B,gCAAgC;QAChC,IAAI;QACJ,WAAW,eAAe;YACxB,OAAO;QACT;QACA,OAAO,CAAA,mBAAoB,GAAG,CAAA,GAAA,eAAO,EACnC,IAAI,CAAC,CAAA,aAAc,CAAC,SAAS,CAAC,OAAO,EACrC;QACF,OAAO,CAAA,KAAM,CACX,IAAsB,EACtB,IAAa,EACb,OAAkB,SAAS;YAE3B,MAAM,MAAM,KAAK,CAAA,OAAQ;YACzB,KAAK,CAAA,UAAW,CAAC;YACjB,IAAI,UAAU;YACd,MAAM,UAAU;gBACd,IAAI,KAAK,CAAA,OAAQ,KAAK,MAAM;oBAC1B,KAAK,CAAA,UAAW,CAAC;oBACjB;gBACF;gBACA,IAAI,SAAS,WACX,KAAK,CAAA,yBAA0B,GAAG,IAAM;qBAExC,mBAAmB,GAAG,CAAC,KAAK,CAAA,gBAAiB,EAAE,MAAM;YAEzD;YACA,IAAI;gBACF,IAAI,QAAQ;gBACZ,IAAI,iBAAiB,KAAK,CAAA,aAAc,EAAE;oBACxC,UAAU;oBAEV,QAAQ,KAAK,CAAA,mBAAoB,CAAC,OAAO;gBAC3C;gBACA,OAAO;YACT,SAAU;gBACR,IAAI,CAAC,SACH;YAEJ;QACF;QACA,OAAO,MAAS,IAAuB,EAAE,IAAa,EAAK;YACzD,IAAI,SAAS,aAAa,CAAE,CAAA,gBAAgB,IAAG,GAC7C,OAAO,KAAK,KAAK,CAAC;YACpB,OAAO,KAAK,CAAA,KAAM,CAAC,MAA0B;QAC/C;QACA,MAAS,IAAa,EAAK;YACzB,OAAO,KAAK,CAAA,KAAM,CAAC,IAAI,EAAE;QAC3B;QACA,OAAO,CAAA,IAAK,CAAI,MAAS,EAAE,OAAkB,SAAS;YACpD,MAAM,OAAO,IAAI,CAAC,CAAA,OAAQ;YAC1B,IAAI,OAAO,WAAW,YAAY;gBAChC,MAAM,MAAM;gBACZ,SAAS,IAAI,OAAO,QAAQ;oBAC1B,OAAM,MAAM,EAAE,OAAO,EAAE,QAAQ;wBAC7B,OAAO,KAAK,CAAA,KAAM,CAChB,MACA,IAAM,SAAS,KAAK,CAAC,QAAQ,SAAS,WACtC;oBAEJ;gBACF;gBACA,4BAA4B;gBAC5B,mBAAmB,GAAG,CAAC,KAAK,CAAA,eAAgB,EAAE,KAAK;YACrD;YACA,OAAO;QACT;QACA,OAAO,KAAQ,MAAS,EAAK;YAC3B,OAAO,IAAI,CAAC,CAAA,IAAK,CAAC;QACpB;QACA,MAAO;YACL,KAAK,MAAM,cAAc;gBAAC;gBAAQ;gBAAS;aAAU,CACnD,6BACE,IAAI,CAAC,CAAA,aAAc,CAAC,SAAS,EAC7B,YACA,IAAI,OAAO,IAAI,CAAC,CAAA,aAAc,CAAC,SAAS,CAAC,WAAW,EAAE;gBACpD,OAAM,MAAM,EAAE,OAAO,EAAE,QAAQ;oBAC7B,IAAK,IAAI,IAAI,GAAG,IAAI,SAAS,MAAM,EAAE,IACnC,QAAQ,CAAC,EAAE,GAAG,KAAK,CAAA,IAAK,CAAC,QAAQ,CAAC,EAAE;oBACtC,OAAO,SAAS,KAAK,CAAC,QAAQ,SAAS;gBACzC;YACF;YAGJ,IACE,iBAAiB,eACjB,OAAO,YAAW,WAAW,KAAK,YAClC,eAAe,YAAW,WAAW,IACrC,OAAO,YAAW,WAAW,CAAC,SAAS,KAAK,YAC5C,sBAAsB,YAAW,WAAW,CAAC,SAAS,IACtD,yBAAyB,YAAW,WAAW,CAAC,SAAS,IACzD,OAAO,YAAW,WAAW,CAAC,SAAS,CAAC,gBAAgB,KACtD,cACF,OAAO,YAAW,WAAW,CAAC,SAAS,CAAC,mBAAmB,KACzD,YACF;gBACA,6BACE,YAAW,WAAW,CAAC,SAAS,EAChC,oBACA,IAAI,OAAO,YAAW,WAAW,CAAC,SAAS,CAAC,gBAAgB,EAAE;oBAC5D,OAAM,MAAM,EAAE,OAAO,EAAE,QAAQ;wBAC7B,IAAK,IAAI,IAAI,GAAG,IAAI,SAAS,MAAM,EAAE,IACnC,QAAQ,CAAC,EAAE,GAAG,KAAK,CAAA,IAAK,CAAC,QAAQ,CAAC,EAAE;wBACtC,OAAO,SAAS,KAAK,CAAC,QAAQ,SAAS;oBACzC;gBACF;gBAEF,6BACE,YAAW,WAAW,CAAC,SAAS,EAChC,uBACA,IAAI,OAAO,YAAW,WAAW,CAAC,SAAS,CAAC,mBAAmB,EAAE;oBAC/D,OAAM,MAAM,EAAE,OAAO,EAAE,QAAQ;wBAC7B,IAAK,IAAI,IAAI,GAAG,IAAI,SAAS,MAAM,EAAE,IACnC,IAAI,OAAO,QAAQ,CAAC,EAAE,KAAK,YACzB,QAAQ,CAAC,EAAE,GACT,mBAAmB,GAAG,CACpB,KAAK,CAAA,eAAgB,EACrB,QAAQ,CAAC,EAAE,KACR,QAAQ,CAAC,EAAE;wBACtB,OAAO,SAAS,KAAK,CAAC,QAAQ,SAAS;oBACzC;gBACF;YAEJ;QACF,CAAC;QACD,aAAc,CAAC;IACjB;AACF","sources":["zone2-core/index.ts"],"sourcesContent":["import {\n  _Proxy as _Proxy_,\n  _Reflect as _Reflect_,\n  snapshot,\n  _WeakMap as _WeakMap_,\n  _WeakMap_prototype as _WeakMap_prototype_,\n} from \"@portal-solutions/hooker-core\";\nconst { isFrozen } = Object;\nfunction trySet<T, K extends keyof T>(obj: T, key: K, val: T[K]): T[K] {\n  if (!isFrozen(obj)) obj[key] = val;\n  return val;\n}\nconst globalThis_: typeof globalThis = globalThis;\nexport interface ZoneProvider {\n  new (): IZone;\n  // awareProxy: typeof Proxy;\n  unawareProxy: typeof Proxy;\n  current: IZone | undefined;\n  hook<T>(a: T): T;\n  enter<T>(zone: IZone | undefined, func: () => T): T;\n}\nexport interface IZone {\n  enter<T>(fn: () => T): T;\n}\nexport interface Global {\n  Promise: typeof Promise;\n  // Proxy: typeof Proxy;\n}\nexport type CreateOpts = {\n  _Proxy?: typeof Proxy;\n  globalThis?: Global;\n  _WeakMap?: typeof _WeakMap_;\n  _WeakMap_prototype?: typeof _WeakMap_prototype_;\n  _Reflect?: typeof Reflect;\n};\nexport function create({\n  _Proxy = _Proxy_,\n  globalThis = globalThis_,\n  _WeakMap = _WeakMap_,\n  _WeakMap_prototype = _WeakMap_prototype_,\n  _Reflect = _Reflect_,\n}: CreateOpts = {}): ZoneProvider {\n  return class Zone implements IZone {\n    static #current: Zone | undefined = undefined;\n    static get current() {\n      return this.#current;\n    }\n    static #setCurrent(targetZone: Zone | undefined) {\n      this.#current = targetZone;\n      while (\n        targetZone &&\n        _WeakMap_prototype.has(this.#conflictResolver, targetZone)\n      ) {\n        const x = _WeakMap_prototype.get(this.#conflictResolver, targetZone);\n        _WeakMap_prototype.remove(this.#conflictResolver, targetZone);\n        x();\n      }\n      while (targetZone === undefined && this.#undefinedConflictResolver) {\n        const old = this.#undefinedConflictResolver;\n        this.#undefinedConflictResolver = undefined;\n        old();\n      }\n    }\n    static #savedPromise: typeof Promise = globalThis.Promise;\n    static #conflictResolver: WeakMap<Zone, () => void> = new _WeakMap();\n    static #proxyMap: WeakMap<any, any> = new _WeakMap();\n    #proxyMapInstance: WeakMap<any, any> = new _WeakMap();\n    static #proxyMapFor(zone: Zone | undefined): WeakMap<any, any> {\n      if (zone === undefined) {\n        return Zone.#proxyMap;\n      }\n      return zone.#proxyMapInstance;\n    }\n    static get #currentProxyMap() {\n      return Zone.#proxyMapFor(Zone.#current);\n    }\n    static #undefinedConflictResolver: (() => void) | undefined = undefined;\n    static #hookedPromise: typeof Promise = trySet(\n      globalThis,\n      \"Promise\",\n      new _Proxy(this.#savedPromise, {\n        apply(target, thisArg, argArray) {\n          if (argArray.length) argArray[0] = Zone.#hook(argArray[0]);\n          return _Reflect.apply(target, thisArg, argArray);\n        },\n        construct(target, argArray, thisArg) {\n          if (argArray.length) argArray[0] = Zone.#hook(argArray[0]);\n          return _Reflect.construct(target, argArray, thisArg);\n        },\n      })\n    );\n    // static #hookedProxy: typeof Proxy = trySet(globalThis, 'Proxy', new _Proxy(globalThis.Proxy, {\n    //     construct(target, argArray, thisArg) {\n    //         if (argArray.length >= 2) argArray[1] = {\n    //             ...new _Proxy(argArray[1], {\n    //                 get(object, key) {\n    //                     return Zone.#hook(_Reflect.get(object, key));\n    //                 }\n    //             })\n    //         };\n    //         return _Reflect.construct(target, argArray, thisArg);\n    //     }\n    // }));\n    // static get awareProxy() {\n    //     return this.#hookedProxy;\n    // }\n    static get unawareProxy() {\n      return _Proxy;\n    }\n    static #savedPromiseFinally = snapshot(\n      this.#hookedPromise.prototype.finally\n    );\n    static #enter<T>(\n      zone: Zone | undefined,\n      func: () => T,\n      type: \"generic\" = \"generic\"\n    ): T {\n      const old = Zone.#current;\n      Zone.#setCurrent(zone);\n      let disable = false;\n      const resolve = () => {\n        if (Zone.#current === zone) {\n          Zone.#setCurrent(old);\n          return;\n        }\n        if (zone === undefined) {\n          Zone.#undefinedConflictResolver = () => resolve();\n        } else {\n          _WeakMap_prototype.set(Zone.#conflictResolver, zone, resolve);\n        }\n      };\n      try {\n        let value = func();\n        if (value instanceof Zone.#hookedPromise) {\n          disable = true;\n\n          value = Zone.#savedPromiseFinally(value, resolve) as T;\n        }\n        return value;\n      } finally {\n        if (!disable) {\n          resolve();\n        }\n      }\n    }\n    static enter<T>(zone: IZone | undefined, func: () => T): T {\n      if (zone !== undefined && !(zone instanceof Zone))\n        return zone.enter(func);\n      return Zone.#enter(zone as Zone | undefined, func);\n    }\n    enter<T>(func: () => T): T {\n      return Zone.#enter(this, func);\n    }\n    static #hook<T>(object: T, type: \"generic\" = \"generic\"): T {\n      const snap = this.#current;\n      if (typeof object === \"function\") {\n        const old = object;\n        object = new _Proxy(object, {\n          apply(target, thisArg, argArray) {\n            return Zone.#enter(\n              snap,\n              () => _Reflect.apply(target, thisArg, argArray),\n              type\n            );\n          },\n        });\n        // if (snap === undefined) {\n        _WeakMap_prototype.set(Zone.#currentProxyMap, old, object);\n      }\n      return object;\n    }\n    static hook<T>(object: T): T {\n      return this.#hook(object);\n    }\n    static {\n      for (const promiseKey of [\"then\", \"catch\", \"finally\"]) {\n        trySet(\n          this.#hookedPromise.prototype,\n          promiseKey as any,\n          new _Proxy(this.#hookedPromise.prototype[promiseKey], {\n            apply(target, thisArg, argArray) {\n              for (let i = 0; i < argArray.length; i++)\n                argArray[i] = Zone.#hook(argArray[i]);\n              return _Reflect.apply(target, thisArg, argArray);\n            },\n          })\n        );\n      }\n      if (\n        \"EventTarget\" in globalThis &&\n        typeof globalThis.EventTarget === \"object\" &&\n        \"prototype\" in globalThis.EventTarget &&\n        typeof globalThis.EventTarget.prototype === \"object\" &&\n        \"addEventListener\" in globalThis.EventTarget.prototype &&\n        \"removeEventListener\" in globalThis.EventTarget.prototype &&\n        typeof globalThis.EventTarget.prototype.addEventListener ===\n          \"function\" &&\n        typeof globalThis.EventTarget.prototype.removeEventListener ===\n          \"function\"\n      ) {\n        trySet(\n          globalThis.EventTarget.prototype,\n          \"addEventListener\",\n          new _Proxy(globalThis.EventTarget.prototype.addEventListener, {\n            apply(target, thisArg, argArray) {\n              for (let i = 0; i < argArray.length; i++)\n                argArray[i] = Zone.#hook(argArray[i]);\n              return _Reflect.apply(target, thisArg, argArray);\n            },\n          })\n        );\n        trySet(\n          globalThis.EventTarget.prototype,\n          \"removeEventListener\",\n          new _Proxy(globalThis.EventTarget.prototype.removeEventListener, {\n            apply(target, thisArg, argArray) {\n              for (let i = 0; i < argArray.length; i++)\n                if (typeof argArray[i] === \"function\")\n                  argArray[i] =\n                    _WeakMap_prototype.get(\n                      Zone.#currentProxyMap,\n                      argArray[i]\n                    ) ?? argArray[i];\n              return _Reflect.apply(target, thisArg, argArray);\n            },\n          })\n        );\n      }\n    }\n    constructor() {}\n  };\n}\n"],"names":[],"version":3,"file":"index.js.map"}